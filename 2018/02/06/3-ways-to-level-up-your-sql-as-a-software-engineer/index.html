<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>3 Ways to Level Up Your SQL as a Software Engineer</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.19-DEV" />
        


        
        
            
                <meta name="description" content="Tai Chi, Code, and Whatever from Dan Kleiman">
            
        

        

  <meta name="twitter:card" content="summary"/>



<meta name="twitter:title" content="3 Ways to Level Up Your SQL as a Software Engineer"/>
<meta name="twitter:description" content="If you are a software engineer and you have just enough SQL to write queries that count, sum, average join and maybe sub-select, then I&rsquo;m writing this post for you. If, when you need more complicated analysis or computation, you pull your query results into excel or your favorite scripting language to do more processing, then I have some good news.

There&rsquo;s a whole lot more you can do right in SQL and it&rsquo;s not too bad to learn how to do it.

In this post, I&rsquo;m going to cover a few concepts that have recently helped me do more computation, better analysis, and it turns out, more efficient querying&hellip;and I hope they help you too.

"/>
<meta name="twitter:site" content="@Dan_Kleiman"/>


        <meta property="og:title" content="3 Ways to Level Up Your SQL as a Software Engineer" />
<meta property="og:description" content="If you are a software engineer and you have just enough SQL to write queries that count, sum, average join and maybe sub-select, then I&rsquo;m writing this post for you. If, when you need more complicated analysis or computation, you pull your query results into excel or your favorite scripting language to do more processing, then I have some good news.

There&rsquo;s a whole lot more you can do right in SQL and it&rsquo;s not too bad to learn how to do it.

In this post, I&rsquo;m going to cover a few concepts that have recently helped me do more computation, better analysis, and it turns out, more efficient querying&hellip;and I hope they help you too.

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dankleiman.com/2018/02/06/3-ways-to-level-up-your-sql-as-a-software-engineer" />



<meta property="article:published_time" content="2018-02-06T12:31:44-05:00"/>
<meta property="article:modified_time" content="2018-02-06T12:31:44-05:00"/>











        
<meta itemprop="name" content="3 Ways to Level Up Your SQL as a Software Engineer">
<meta itemprop="description" content="If you are a software engineer and you have just enough SQL to write queries that count, sum, average join and maybe sub-select, then I&rsquo;m writing this post for you. If, when you need more complicated analysis or computation, you pull your query results into excel or your favorite scripting language to do more processing, then I have some good news.

There&rsquo;s a whole lot more you can do right in SQL and it&rsquo;s not too bad to learn how to do it.

In this post, I&rsquo;m going to cover a few concepts that have recently helped me do more computation, better analysis, and it turns out, more efficient querying&hellip;and I hope they help you too.

">


<meta itemprop="dateModified" content="2018-02-06T12:31:44-05:00" />
<meta itemprop="wordCount" content="1560">



<meta itemprop="keywords" content="BTC,BigQuery,Code,Courses and Events,Energy Arts,Events,Golang,Inner Form,Launch Academy,Learning,Meditation,Movement Practice,Octopress,Practice People,Practice Tip,Psychology,Qigong,Rails,RailsConf,Ruby,SQL,Security,Sinatra,Site,Small Business,Static Sites,Tai Chi,Trainerfly,Twilio,Xing Yi,1000 True Fans,5 Elements,An,BC,BJ Fogg,Ba Gua,Balance,Behavior Change,Bend the Bow,Bill Ryan,Breathing,Breathing Exercise,Breathing For Relaxation,Brookline Tai Chi,Bruce Frantzis,Bruce Lee,Business Tools,Cathy Kerr,Central Equilibrium,Cheng Man Ching,Chi,Chicago Tai Chi,Chinese Medicine,Cloud Hands,Conflict Resolution,Creativity,Crossfit,DPH,Daily Practice,David-Dorian Ross,Deliberate Practice,Design,Diaphragmatic Breathing,Don Ethan Miller,Dorothy Fitzer,Dr. Mark Cheng,Dragon and Tiger,Elephant Wrestling,Energies,Energy,Energy Arts,Energy Gates Dissolving Series,Enterprise of One,Entrepreneurship,Exercise Mp3,Eyes,Fall Prevention,Favorite Quotes,Feedback,Feng Zhiqiang,Five Movement Centers,Foundations of Relaxation,Fuzhong Li,Gaming,Gods Playing in the Clouds,Harvard Medical School,Harvard Medical School Guide,Health Month,Heath Brothers,Heaven and Earth,Hot Triggers,Immersion,Inc. Magazine,Inner Form,Inner Game of Tennis,Instructor Training,Intrinsic Motivation,Intuition,Isaac Kamins,Jane McGonigal,Ji,Josh Kaufman,Learning Tai Chi,Lee Scheele,Leverage,Lu,Marriage of Heaven and Earth,Master Wang Hao Da,Medicine,Meditate,Meditation,Meditation Practice,Mobile,Mobility,Moodle,Motivation,Myth of the Overworked Creative,Online Learning,Opening and Closing,Pain,Paul Cavel,Peng,Perfect Practice,Personal MBA,Personal Practice,Peter Wayne,Posture,Product Launch,Productivity,Pulsing,Push Hands,Qi,Qigong,Qigong Breathing,Qigong Practice,Qigong Radio,Qigong Youtube,Quantity,Ramit Sethi,Rhythm,Robert Tangora,Running a school,San Ti,Seasonal Practice,Sitting Practice,Spinal Qigong,Spiraling Energy Body,Spiritual Practice,Standing Qigong,Standing Series,Stanford,State of the Art,Stretch,Swing,Swings,Switch,Systems,T&#39;ai Chi Ch&#39;uan,T&#39;ai Chi for Health and Happiness,TED talks,Tai Chi,Tai Chi Classics,Tai Chi Equipment Training,Tai Chi Mastery Program,Tai Chi Postures,Tai Chi Practice,Tai Chi Principles,Tai Chi Research,Tai Chi Teacher,Taoist Arts,TechCrunch,Technology,The Tools,Tony Schwartz,Traditional Chinese Medicine,Trainerfly Backstory,Travel,Vancouver,Vision,Visual Training,Week,Wordpress,Wu Jianquan,Wu Short Form Instructor Training 2011,Yoga,Your Practice,Z Health,alignments,anxiety,case study,chi gung,depression,dissolving,energy gates,energy management,fear,feet,flexibility,four points,joint mobility,kwa,learning,mind,neigong,practice,practice tips,problem solving,relaxation,rooting,seminars,sinking,small business marketing,song,spine,standing,stress,teaching,twisting,xingyi,yin and yang,zhong ding," />

        

        
            
        

        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css">
            <link rel="stylesheet" href="https://dankleiman.com/css/main.css">
            <link rel="stylesheet" href="https://dankleiman.com/css/add-on.css">
        

        
            
                
            
        

        
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-19970008-2', 'auto');
ga('send', 'pageview');
</script>

        
    </head>
    <body>

      
      <div id="wrapper">

    
    
<header id="header">
    
      <h1><a href="https://dankleiman.com/">post</a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/">
                            <i class="fa fa-home">&nbsp;</i>Home
                    </a>
                </li>
            
                <li>
                    <a href="/about/">
                            <i class="fa fa-id-card-o">&nbsp;</i>About
                    </a>
                </li>
            
                <li>
                    <a href="/post/">
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories/">
                            <i class="fa fa-sitemap">&nbsp;</i>Categories
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="as_sitesearch" value="https://dankleiman.com/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="as_sitesearch" value="https://dankleiman.com/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/">
                            <h3>
                                <i class="fa fa-home">&nbsp;</i>Home
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about/">
                            <h3>
                                <i class="fa fa-id-card-o">&nbsp;</i>About
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/">
                            <h3>
                                <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories/">
                            <h3>
                                <i class="fa fa-sitemap">&nbsp;</i>Categories
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section id="recent-posts">
            <div class="mini-posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                

                
                    
                

                
                        <article class="mini-post">
                            <header>
                                <h3><a href="https://dankleiman.com/2019/08/30/sql-quick-tip-present-cleaner-results-with-custom-ordering">SQL Quick Tip: Present Cleaner Results with Custom Ordering</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-08-30'>
                                    August 30, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="https://dankleiman.com/2019/02/16/roll-your-own-database-part-1">Roll Your Own Database: Part 1</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-02-16'>
                                    February 16, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="https://dankleiman.com/2019/02/05/seed-data-for-your-wip-sql-queries">Seed Data for Your WIP SQL Queries</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-02-05'>
                                    February 5, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="https://dankleiman.com/2019/01/02/stop-writing-sql-backwards">Stop Writing SQL Backwards</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-01-02'>
                                    January 2, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="https://dankleiman.com/2018/02/06/3-ways-to-level-up-your-sql-as-a-software-engineer">3 Ways to Level Up Your SQL as a Software Engineer</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-02-06'>
                                    February 6, 2018</time>
                            </header>
                            

                        </article>
                

                
                    <a href=
                        
                            /post/
                        
                        class="button">View more posts</a>
                
            </div>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li>
  <a href="//twitter.com/share?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&text=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer&via=Dan_Kleiman" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>


<li>
  <a href="//plus.google.com/share?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>


<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>


<li>
  <a href="//reddit.com/submit?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&title=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>


<li>
  <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&title=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>


<li>
  <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&title=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>


<li>
  <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&description=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>


<li>
  <a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
  <header>
    <div class="title">
        
            <h1><a href="https://dankleiman.com/2018/02/06/3-ways-to-level-up-your-sql-as-a-software-engineer">3 Ways to Level Up Your SQL as a Software Engineer</a></h1>
            
        
        
    </div>
    <div class="meta">
        

        <time class="published"
            datetime='2018-02-06'>
            February 6, 2018</time>
        <span class="author"></span>
        
            <p>8 minute read</p>
        
        
    </div>
</header>


  
    <section id="social-share">
      <ul class="icons">
        


<li>
  <a href="//twitter.com/share?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&text=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer&via=Dan_Kleiman" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>


<li>
  <a href="//plus.google.com/share?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>


<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>


<li>
  <a href="//reddit.com/submit?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&title=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>


<li>
  <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&title=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>


<li>
  <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&title=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>


<li>
  <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer&description=3%20Ways%20to%20Level%20Up%20Your%20SQL%20as%20a%20Software%20Engineer" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>


<li>
  <a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fdankleiman.com%2f2018%2f02%2f06%2f3-ways-to-level-up-your-sql-as-a-software-engineer" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>

      </ul>
    </section>
  

  

  <div id="content">
    <p>If you are a software engineer and you have just enough SQL to write queries that count, sum, average join and maybe sub-select, then I&rsquo;m writing this post for you. If, when you need more complicated analysis or computation, you pull your query results into excel or your favorite scripting language to do more processing, then I have some good news.</p>

<p>There&rsquo;s a whole lot more you can do right in SQL and it&rsquo;s not too bad to learn how to do it.</p>

<p>In this post, I&rsquo;m going to cover a few concepts that have recently helped me do more computation, better analysis, and it turns out, more efficient querying&hellip;and I hope they help you too.</p>

<p></p>

<h2 id="dry-up-your-sql-with-common-table-expressions">DRY up your SQL with Common Table Expressions</h2>

<p>A Common Table Expression, or CTE, works just like a normal SELECT statement, but it gets evaluated at the beginning of your query and stored as a view, or temporary table, that can be referenced over and over throughout the rest of the query.</p>

<p>In your code, you wouldn&rsquo;t do the same expensive calculation over and over, right? In your SQL, when you use CTEs, you don&rsquo;t have to either. Especially if you&rsquo;re dealing with large data sets, querying for a small, relevant subset up front and working with those rows as a table is way more efficient.</p>

<p>In fact, not only are CTEs more efficient in a lot of cases, but I&rsquo;ve come to see that having a series of CTEs at the beginning of my query ends up making the main SELECT statement much easier to read. You&rsquo;ve stuffed all the complicated logic into the CTEs and given them meaningful names, so what you end up joining and projecting tend to be much easier to reason about.</p>

<p><strong>Example</strong></p>

<p>You are running a split test with two groups of users. Each user is assigned to one variant in the test based on some hashing of their user id. The user id and the test variant are stored in a table of user-test-variant mappings, or our &lsquo;experiment&rsquo; table. You want to track the variants of this test through a series of events and put together an event funnel for each group.</p>

<pre><code>WITH experiment AS (
  SELECT
    user_id,
    variant
  FROM
    `big_table_of_experiments`
  WHERE
    test_id = '123'
),
  event_one AS (
  SELECT
    important_event,
    variant,
    COUNT(1) AS count
  FROM
    `big_table_of_events_one` c
  JOIN
    experiment
  ON
    c.user_id = experiment.user_id
  GROUP BY
    1,
    2
    ),
  event_two AS (
  SELECT
    important_event,
    variant,
    COUNT(1) AS count
  FROM
    `big_table_of_events_two` a
  JOIN
    experiment
  ON
    a.user_id = experiment.user_id
  GROUP BY
    1,
    2)
SELECT
  event_one.important_event,
  event_one.variant,
  event_one.count as first_event,
  COALESCE(event_two.count, 0) AS second_event,
  CASE
    WHEN COALESCE(event_two.count, 0) = 0 THEN 0
    ELSE ROUND((event_two.count * 100/event_one.count), 5)
  END AS event_two_conversion_rate
FROM
  event_one
LEFT OUTER JOIN
  event_two
ON
  event_one.variant = event_two.variant
ORDER BY
  1,
  2,3
</code></pre>

<p>Read the query above in this order:</p>

<ol>
<li>Jump down the to SELECT statement at the bottom. Is it easy to explain what the query does overall?</li>
<li>Back to the top. For each CTE defined by the WITH some_cte_name AS (simpler SELECT), can you understand the individual building blocks of the query?</li>
</ol>

<p>If the event tables are really big, doing that left outer join is going to be really expensive. But in this case, we&rsquo;ve already filtered down our data twice: once with each inner join on the specific users we want and once with whatever other criteria we wanted to use a filter in the WHERE clauses in each of the event CTEs (left out in the actual example, but presumably you&rsquo;d have some if you were pulling from a big complicated data source). In the end, the rows you end up joining and projecting are fewer and the query itself is more readable because you&rsquo;ve clearly defined each piece.</p>

<h2 id="learn-to-love-over">Learn to Love OVER()</h2>

<p>Analytic or window functions can be a really powerful way to do calculations in your queries without having to do any post-processing in code or excel. The other day at work, I was asked to look into the data behind a conversion rate, like the example above, for a series of events, that seemed to be bouncing all over the place with every new day of data we added.</p>

<p>My first pass at calculating the conversion rate looked something like this. The problem was, we expected to see a uniform rate, even though the number of events changed every day:</p>

<pre><code>SELECT
  day,
  event_one,
  event_two,
  ROUND(event_two * 100/event_one,2) as event_cvr,
FROM
  event_two_data
JOIN
  event_one_data
ON 
  event_one_data.day = event_two_data.day
ORDER BY 1
</code></pre>

<p>Eventually, what I realized was that, not only had there had been huge swings in the &lsquo;event_one&rsquo; numbers day-over-day, but the typical time between event one and event two spanned multiple days. In other words, you&rsquo;d have a really big numerator in the event_cvr calculation one day, then a really small one the next day, but the denominator was a day or two behind in its corresponding fluctuation.</p>

<p>The problem was still, I didn&rsquo;t know if it was a day&hellip;or two. The solution was LAG.</p>

<p>Here&rsquo;s how the query evolved to account for the delay between event_one and event_two. Using the LAG() function with a window, I could essentially shift the rows so that for any given day, I could compare event_two numbers to event_one numbers on the same day, the previous day, or the day before that.</p>

<p>Since the events were happening mostly a day to two days apart, the &ldquo;one_day_cvr&rdquo; and &ldquo;two_day_cvr&rdquo; numbers ended up looking much more uniform.</p>

<pre><code>SELECT
  day,
  event_one,
  event_two,
  ROUND(event_two * 100/event_one,2) as same_day_cvr,
  ROUND(event_two * 100/ LAG(event_one,1) OVER(ORDER BY day) ,2) as one_day_cvr,
  ROUND(event_two * 100/LAG(event_one,2) OVER(ORDER BY day),2) as two_day_cvr
FROM
  event_two_data
JOIN
  event_one_data
ON 
  event_one_data.day = event_two_data.day
ORDER BY 1
</code></pre>

<p>You can use LAG() to reference previous rows as in the example above, but you can also do other calculations using the OVER() window.</p>

<p>As an example, let&rsquo;s use a CTE to throw some fake data into BigQuery and ask for a breakdown of counts by color and style, a total of items by style, and the percentage of any given color-style-size combo to the total number of items in that style.</p>

<p>With a window function, you can ask for all of those breakdowns in a single query:</p>

<pre><code>WITH
  inventory AS (
  SELECT 'buttons' AS style, 'blue' AS color, 'large' AS size
  UNION ALL SELECT 'buttons', 'blue', 'small'
  UNION ALL SELECT 'buttons', 'blue', 'small'
  UNION ALL SELECT 'zipper', 'red', 'large'
  UNION ALL SELECT 'zipper', 'blue', 'small'
  UNION ALL SELECT 'zipper', 'green', 'medium')
SELECT
  style,
  color,
  size,
  COUNT(1) AS color_sizes_by_style,
  COUNT(style) OVER(PARTITION BY style) as total_style,
  ROUND(COUNT(1) * 100 / COUNT(style) OVER(PARTITION BY style),2) AS percent_of_total_style
FROM
  inventory
GROUP BY 1, 2, 3
ORDER BY 1, 2, 3
</code></pre>

<p>In your result set you get the expected count by style, color, and size for each group of items, but now, because of the window function, you&rsquo;ve also been able to do a calculation for each row that uses a different grouping &ndash; in this case a less granular, style-only grouping &ndash; to get a total count from a different set of rows.</p>

<p><img src="/img/inventory.png" alt="Inventory results grouped by style and color-sizes"></p>

<p>The window you get with the OVER() function let&rsquo;s you define your input distinctly from the way you&rsquo;ve defined it in your main query, but then returns a value for each row into the query. Previously, I would have done this with a sub-select or some post-processing, but now I understand how to do computation over multiple data breakdowns as part of a normal query.</p>

<p>I&rsquo;m sure the name &ldquo;window function&rdquo; has some other origin, but I like to think of it as giving you a window into other rows in the table that you can reach through and steal data from.</p>

<p>Check out these <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#analytic-functions">BigQuery docs on Analytic Functions</a> for deeper explanation and some cool examples.</p>

<h2 id="aggregates-are-lies">Aggregates are Lies</h2>

<p>Finally, I want to encourage you <strong>to be skeptical of aggregate data</strong> for two big reasons. First, aggregates are lies &ndash; real, interesting, and accurate data is hidden inside the fluctuations you roll up into your aggregate data. Don&rsquo;t be fooled.</p>

<p>Second, as you learn to write more complicated queries, you&rsquo;ll be tempted to use your fancy tools right away. Don&rsquo;t do it.</p>

<p>Any time you&rsquo;re tackling a new query with new data, you should pour over the undisturbed rows to get a feel for what kinds of variations are hidden there.</p>

<p>I don&rsquo;t have formal rules yet for developing complicate analytics queries, but if I had to put what I think the process looks like into an ordered list today, I would do something like this:</p>

<ol>
<li>Preview complete rows of the data, not just columns you want to roll up.</li>
<li>Do some simple ordering on column values to see ranges and outliers.</li>
<li>Do some simple grouping with counts on potentially useful columns to see breakdowns of data.</li>
<li>If possible, validate calculations side-by-side with raw data, at least for a sanity check.</li>
</ol>

<p>Aggregate data tells a lot of important stories, I&rsquo;m not denying that. But you&rsquo;re in an interesting position as a software engineer who can write more analytical SQL. You get to see the resulting data AND the code that generated it.</p>

<p>Go slow with the data and piece together the specifics as much as possible. That will tell you a lot more about how your code is interacting with the world than looking at rolled-up, averaged, grouped, or otherwised calculated numbers.</p>
  </div>

  <footer>
    <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    
                        <i class="fa fa-sitemap">&nbsp;</i>
                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/code'>Code</a></li>
    
        <li><a href='/categories/sql'>SQL</a></li>
    
</ul>

  </footer>

</article>


<ul class="actions pagination">
    
        <li><a href="https://dankleiman.com/2018/01/28/keeping-an-engineering-notebook"
                class="button big previous">Keeping an Engineering Notebook</a></li>
    

    
        <li><a href="https://dankleiman.com/2019/01/02/stop-writing-sql-backwards"
                class="button big next">Stop Writing SQL Backwards</a></li>
    
</ul>


    </div>
    
<section id="sidebar">

  
  <section id="intro">
    
    
      
        <a href='/'><img src="/img/main/headshot.jpg" class="intro-circle" width="150" alt="Dan Kleiman" /></a>
      
    
    
      <header>
        <h2>Dan Kleiman</h2>
        <p>Posts about code and work and some tai chi archives too</p>
      </header>
    
    
      <ul class="icons">
        
          <li>
            <a href="" type="application/rss+xml" target="_blank" title="RSS" class="fa fa-rss"></a>
          </li>
        
        
  <li><a href="//github.com/dankleiman" target="_blank" title="GitHub" class="fa fa-github"></a></li>

























  <li><a href="//linkedin.com/in/dlkleiman" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>













  <li><a href="//reddit.com/user/upalready" target="_blank" title="Reddit" class="fa fa-reddit"></a></li>





















  <li><a href="//twitter.com/Dan_Kleiman" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>













  <li><a href="mailto:info@dankleiman.com" title="Email" class="fa fa-envelope"></a></li>


      </ul>
    
  </section>

  
  
    <section id="mini-bio">
        <div id='mc_embed_signup'><form action='https://dankleiman.us1.list-manage.com/subscribe/post?u=0e4a1aa488d23c693881caeec&amp;id=99d1412a0b' method='post' id='mc-embedded-subscribe-form' name='mc-embedded-subscribe-form' class='validate' target='_blank' novalidate><div id='mc_embed_signup_scroll'><h2>Stay up to date via email</h2><div class='mc-field-group'><label for='mce-EMAIL'>Your Email Address</label><input type='email' value='' name='EMAIL' class='required email' id='mce-EMAIL'></div><div id='mce-responses' class='clear'><div class='response' id='mce-error-response' style='display:none'></div><div class='response' id='mce-success-response' style='display:none'></div></div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--><div style='position: absolute; left: -5000px;' aria-hidden='true'><input type='text' name='b_0e4a1aa488d23c693881caeec_99d1412a0b' tabindex='-1' value=''></div><div class='clear'><input type='submit' value='Subscribe' name='subscribe' id='mc-embedded-subscribe' class='button'></div></div></form></div>
    </section>
  

  
  <section id="recent-posts">
    <div class="mini-posts">
      <header>
        <h3>Recent Posts</h3>
      </header>
      <div class="posts-container">
        

        
          
        

        
          <article class="mini-post">
            <header>
              <h3>
                <a href="https://dankleiman.com/2019/08/30/sql-quick-tip-present-cleaner-results-with-custom-ordering">SQL Quick Tip: Present Cleaner Results with Custom Ordering</a>
              </h3>
              
              <time class="published" datetime='2019-08-30'>
                August 30, 2019
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="https://dankleiman.com/2019/02/16/roll-your-own-database-part-1">Roll Your Own Database: Part 1</a>
              </h3>
              
              <time class="published" datetime='2019-02-16'>
                February 16, 2019
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="https://dankleiman.com/2019/02/05/seed-data-for-your-wip-sql-queries">Seed Data for Your WIP SQL Queries</a>
              </h3>
              
              <time class="published" datetime='2019-02-05'>
                February 5, 2019
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="https://dankleiman.com/2019/01/02/stop-writing-sql-backwards">Stop Writing SQL Backwards</a>
              </h3>
              
              <time class="published" datetime='2019-01-02'>
                January 2, 2019
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="https://dankleiman.com/2018/02/06/3-ways-to-level-up-your-sql-as-a-software-engineer">3 Ways to Level Up Your SQL as a Software Engineer</a>
              </h3>
              
              <time class="published" datetime='2018-02-06'>
                February 6, 2018
              </time>
            </header>
            

          </article>
        
      </div>

      
        <a href=
          
            /post/
          
        class="button">View more posts</a>
      
    </div>
  </section>

  
  
  
  
    <section id="categories">
      <header>
        <h3>
          <a href="/categories/">Categories</a>
        </h3>
      </header>
        
          
        

        
        <p>
          <article>
            <header>
              
                <a href="/categories/tai-chi/">Tai Chi</a>
                <span style="float:right;">85</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/qigong/">Qigong</a>
                <span style="float:right;">74</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/code/">Code</a>
                <span style="float:right;">34</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/movement-practice/">Movement Practice</a>
                <span style="float:right;">33</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/small-business/">Small Business</a>
                <span style="float:right;">21</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/inner-form/">Inner Form</a>
                <span style="float:right;">14</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/practice-people/">Practice People</a>
                <span style="float:right;">12</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/practice-tip/">Practice Tip</a>
                <span style="float:right;">10</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/launch-academy/">Launch Academy</a>
                <span style="float:right;">9</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/psychology/">Psychology</a>
                <span style="float:right;">9</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/btc/">BTC</a>
                <span style="float:right;">5</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/events/">Events</a>
                <span style="float:right;">5</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/sql/">SQL</a>
                <span style="float:right;">5</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/site/">Site</a>
                <span style="float:right;">5</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/trainerfly/">Trainerfly</a>
                <span style="float:right;">5</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/bigquery/">BigQuery</a>
                <span style="float:right;">3</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/energy-arts/">Energy Arts</a>
                <span style="float:right;">3</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/twilio/">Twilio</a>
                <span style="float:right;">3</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/golang/">Golang</a>
                <span style="float:right;">2</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/octopress/">Octopress</a>
                <span style="float:right;">2</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/rails/">Rails</a>
                <span style="float:right;">2</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/ruby/">Ruby</a>
                <span style="float:right;">2</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/static-sites/">Static Sites</a>
                <span style="float:right;">2</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/courses-and-events/">Courses and Events</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/learning/">Learning</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/meditation/">Meditation</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/railsconf/">RailsConf</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/security/">Security</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/sinatra/">Sinatra</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/xing-yi/">Xing Yi</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
    </section>
  

  
  

  
  <section id="footer">
    
      <ul class="icons">
        
          <li>
            <a href="" type="application/rss+xml" target="_blank" title="RSS" class="fa fa-rss"></a>
          </li>
        
        
  <li><a href="//github.com/dankleiman" target="_blank" title="GitHub" class="fa fa-github"></a></li>

























  <li><a href="//linkedin.com/in/dlkleiman" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>













  <li><a href="//reddit.com/user/upalready" target="_blank" title="Reddit" class="fa fa-reddit"></a></li>





















  <li><a href="//twitter.com/Dan_Kleiman" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>













  <li><a href="mailto:info@dankleiman.com" title="Email" class="fa fa-envelope"></a></li>


      </ul>
    
    <p class="copyright">
      
        &copy; 2019
        
          Dan Kleiman
        
      .
      Powered by <a href="//gohugo.io" target="_blank">Hugo</a>
    </p>
  </section>
</section>

    </div>
    <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
    

    
      
    

    
    
      <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>
      <script src="https://dankleiman.com/js/util.js"></script>
      <script src="https://dankleiman.com/js/main.js"></script>
      <script src="https://dankleiman.com/js/backToTop.js"></script>
    

    
      
        
      
    

    
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

